#include "keyboard.h"
#include "io.h"
#include "utils.h"

// Порт, к которому подключена клавиатура (обычно 0x60 для стандартной клавиатуры)
#define KEYBOARD_PORT 0x60
#define KEYBOARD_STATUS_PORT 0x64

// Структура для кодов клавиш
static const char keymap[128] = {
    [0] = 0, [1] = 0, [2] = '1', [3] = '2', [4] = '3', [5] = '4', [6] = '5', [7] = '6', [8] = '7', [9] = '8',
    [10] = '9', [11] = '0', [12] = '-', [13] = '=', [14] = 0, [15] = 0, [16] = 'q', [17] = 'w', [18] = 'e',
    [19] = 'r', [20] = 't', [21] = 'y', [22] = 'u', [23] = 'i', [24] = 'o', [25] = 'p', [26] = '[', [27] = ']',
    [28] = '\n', [29] = 0, [30] = 'a', [31] = 's', [32] = 'd', [33] = 'f', [34] = 'g', [35] = 'h', [36] = 'j',
    [37] = 'k', [38] = 'l', [39] = ';', [40] = '\'', [41] = '`', [42] = 0, [43] = '\\', [44] = 'z', [45] = 'x',
    [46] = 'c', [47] = 'v', [48] = 'b', [49] = 'n', [50] = 'm', [51] = ',', [52] = '.', [53] = '/', [54] = 0,
    [55] = 0, [56] = 0, [57] = ' ', [58] = 0, [59] = 0, [60] = 0, [61] = 0, [62] = 0, [63] = 0, [64] = 0,
    [65] = 0, [66] = 0, [67] = 0, [68] = 0, [69] = 0, [70] = 0, [71] = 0, [72] = 0, [73] = 0, [74] = 0,
    [75] = 0, [76] = 0, [77] = 0, [78] = 0, [79] = 0, [80] = 0, [81] = 0, [82] = 0, [83] = 0, [84] = 0
};

// Инициализация клавиатуры
void init_keyboard(void) {
    // Инициализация портов для обработки данных с клавиатуры
    outb(KEYBOARD_STATUS_PORT, 0xAE);  // Включение клавиатуры
    outb(KEYBOARD_STATUS_PORT, 0x20);  // Установка рабочей настройки
    unsigned char status = inb(KEYBOARD_STATUS_PORT);
    outb(KEYBOARD_STATUS_PORT, status | 1);  // Разрешение прерываний
    print_string("Keyboard initialized.\n");
}

// Обработчик прерываний клавиатуры
void keyboard_interrupt_handler(void) {
    unsigned char scancode = inb(KEYBOARD_PORT); // Чтение скан-кода клавиши

    // Если скан-код в пределах допустимого диапазона
    if (scancode < 128) {
        char key = keymap[scancode];
        if (key != 0) {
            write_char(key);  // Выводим символ на экран
        }
    }
}

// Вспомогательные функции для вывода символов
void write_char(char c) {
    // В зависимости от реализации вывода, здесь можно использовать
    // разные функции для отображения символа на экране
    print_char(c);  // Например, для текстового режима можно использовать print_char
}
